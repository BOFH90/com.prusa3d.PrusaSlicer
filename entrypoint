#!/usr/bin/env sh

set -e

#export LC_MEASUREMENT=nb_NO.UTF-8

PRUSA_SLICER_APP_LOG=/tmp/com.prusa3d.PrusaSlicer.log
PRUSA_SLICER_APP_ENV=/tmp/com.prusa3d.PrusaSlicer.env
PRUSA_SLICER_APP_ARGS=("$@")
PRUSA_SLICER_APP=/app/bin/prusa-slicer
PRUSA_SLICER_APP_APPLY_THEME=/app/bin/get_window_ids.py
PRUSA_SLICER_APP_LOCALE_ERROR="An error occured while setting up locale"
PRUSA_SLICER_APP_FALLBACK_LOCALE=en_US.UTF-8

app_is_running() {
    (ps aux | grep "$PRUSA_SLICER_APP" | grep -v "grep") >/dev/null
    [ $? == 0 ] && echo true || echo false
}

app_pid() {
    echo $(pgrep -f $PRUSA_SLICER_APP)
}

app_detected_locale_issue() {
    (grep "$PRUSA_SLICER_APP_LOCALE_ERROR" $PRUSA_SLICER_APP_LOG) >/dev/null
    [ $? == 0 ] && echo true || echo false
}

app_wait() {
    wait_begin=1
    wait_until=$1
    while [ $(app_is_running) == true ]; do
        #echo -e " --------------------------------------------------------------------------------------"
        #echo -e " ‚ö´  PrusaSlicer is starting : $(app_is_running)  $(expr $(($wait_until + 1)) - $wait_begin)"
        #echo -e " --------------------------------------------------------------------------------------"
        [ $wait_begin == $wait_until ] && break
        sleep 1
        wait_begin=$(($wait_begin + 1))
    done
    echo -e " --------------------------------------------------------------------------------------"
    [ $(app_is_running) == true ] && echo -e " üü¢  PrusaSlicer is running, pid $(app_pid)" || echo -e " üî¥  PrusaSlicer stopped running!"
    echo -e " --------------------------------------------------------------------------------------"
    #[ $(app_is_running) == false ] && echo -e "\n-- $PRUSA_SLICER_APP_LOG -- >>>\n" && cat $PRUSA_SLICER_APP_LOG && echo -e "\n<<< --\n"
}

apply_dark_window() {
    while IFS= read -r window_id; do
        (xprop -f _GTK_THEME_VARIANT 8u -set _GTK_THEME_VARIANT "dark" -id "$window_id") &>>/dev/null
    done <<<$($PRUSA_SLICER_APP_APPLY_THEME)
}

app_start() {
    source $PRUSA_SLICER_APP_ENV

    RETRY_STEP=$1

    [ $RETRY_STEP == 0 ] && echo -e " üé≤  PrusaSlicer, executed $PRUSA_SLICER_APP $PRUSA_SLICER_APP_ARGS"
    [ $RETRY_STEP == 2 ] && echo -e " üé≤  PrusaSlicer, executed again with LC_ALL=$LC_ALL"
    [ $RETRY_STEP == 3 ] && echo -e " üé≤  PrusaSlicer, executed with previous generated $PRUSA_SLICER_APP_ENV"

    (exec $PRUSA_SLICER_APP ${PRUSA_SLICER_APP_ARGS[@]} &) 2>$PRUSA_SLICER_APP_LOG 1>/dev/null
    [ $PRUSA_SLICER_DARK_THEME == true ] && (apply_dark_window &)
}

override_locale() {
    [ -n "$LANG" ] && echo -e "export LC_ALL=$LANG" >>$PRUSA_SLICER_APP_ENV ||
        echo -e "export LC_ALL=$PRUSA_SLICER_APP_FALLBACK_LOCALE" >>$PRUSA_SLICER_APP_ENV
}

check() {
    maximum_retrys=$1
    while [ $maximum_retrys -le 3 ]; do
        if [ $(app_is_running) == true ]; then
            break
        else
            maximum_retrys=$(($maximum_retrys + 1))

            [ $(app_detected_locale_issue) ] && override_locale && echo -e " üü†  PrusaSlicer: $PRUSA_SLICER_APP_LOCALE_ERROR!" && echo -e " --------------------------------------------------------------------------------------"
            app_start $maximum_retrys
            app_wait 5
        fi
    done
}

echo -e "\n"
echo -e " PRUSA SLICER startup script for flatpak package on flathub.org"
echo -e " --------------------------------------------------------------------------------------"
echo -e " this startup script was written as a workaround and adresses some locale issues that "
echo -e " prevented PrusaSlicer from starting up when working in a mixed locale enviroment."
echo -e " Also some initial support for dark theme/variant was added.\n"
echo -e " Disable dark theme/variant with --env=PRUSA_SLICER_DARK_THEME=false\n"
echo -e " Links:\n  - https://github.com/flathub/com.prusa3d.PrusaSlicer/blob/beta/entrypoint"
echo -e "  - https://github.com/flathub/com.prusa3d.PrusaSlicer/pull/33"
echo -e " --------------------------------------------------------------------------------------\n"

RETRY=0

if [ -f $PRUSA_SLICER_APP_ENV ] && [ -f $PRUSA_SLICER_APP_LOG ]; then
    RETRY=3
fi

[ $RETRY == 0 ] && [ ! -f $PRUSA_SLICER_APP_ENV ] && echo -e "# start of $PRUSA_SLICER_APP_ENV file" >$PRUSA_SLICER_APP_ENV
[ $RETRY == 0 ] && [ ! -f $PRUSA_SLICER_APP_LOG ] && echo -e "# start of $PRUSA_SLICER_APP_LOG file" >$PRUSA_SLICER_APP_LOG
[ $RETRY == 0 ] && [ $PRUSA_SLICER_DARK_THEME == true ] && echo -e "export GTK_THEME='Adwaita:dark'" >>$PRUSA_SLICER_APP_ENV

[ ! -e $PRUSA_SLICER_APP_ENV ] && echo -e "‚ùó $PRUSA_SLICER_APP_ENV file not found!" && exit 1
[ ! -e $PRUSA_SLICER_APP_LOG ] && echo -e "‚ùó $PRUSA_SLICER_APP_LOG file not found!" && exit 1

(
    app_start $RETRY &
    app_wait 5
)

if [ $(app_is_running) == false ]; then
    RETRY=$(($RETRY + 1))
    (check $RETRY)
fi
